[default]
# Produto Metadata
app_name = "Verificador Inteligente de Orçamentos de Obras"
squad_name = "DataCraft"
app_version = "0.0.1"

# Configuração - Validador LPU
[default.module_validator_lpu]

# Indica se queremos uma execução de código mais detalhada em prints (verbosa)
verbosa = true

# Tolerância de divergência para status de conciliação (%)
tol_percentile = 0.0

# Colunas padrão para cálculo de discrepâncias
column_quantity = "QUANTIDADE"
column_unit_price_paid = "PRECO PAGO"
column_unit_price_lpu = "PRECO LPU"
column_total_paid = "VALOR TOTAL PAGO"
column_total_lpu = "VALOR TOTAL LPU"
column_difference = "DIFERENÇA TOTAL"
column_discrepancy = "DISCREPÂNCIA PERCENTUAL"
column_status = "RESULTADO VALIDADOR LPU"
name_status_nullable = "ITEM NAO LPU"
name_status_ok = "OK"
name_status_payment_more = "PARA RESSARCIMENTO"
name_status_payment_less = "OK"

# Opção para obter as estatísticas de status LPU
get_lpu_status = true

[default.module_validator_lpu.agencies_data]

# Base de Agências
file_path = "data/inputs/agencias/BASE_AGENCIAS.xlsx"
sheet_name = "Sheet1"
header = 1

# Colunas obrigatórias com tipos
required_columns_with_types = {"CD_PONTO" = "int", "NOME DO PONTO" = "object", "REGIAO" = "object", "UF" = "object", "MUNICIPIO" = "object"}

# Lista de colunas para selecionar
list_columns_select = ["CD_PONTO", "NOME DO PONTO", "MUNICIPIO", "UF", "REGIAO"]

# Colunas para normalização de valores
cells_to_remove_spaces = []
cells_to_remove_accents = []

# Validando se é desejado salvar os dados após processamento
validator_save_sot = true
dir_path_file_sot = "data/outputs/sor/01_SOR_BASE_AGENCIAS.xlsx"

[default.module_validator_lpu.constructors_data]

# Base de Construtoras
file_path = "data/inputs/construtoras/BASE_GRUPOS_CONSTRUTORAS.xlsx"
sheet_name = "Sheet1"

# Colunas obrigatórias com tipos
required_columns_with_types = {"FORNECEDOR" = "object", "REGIAO" = "object", "GRUPO" = "object"}

# Lista de colunas para selecionar
list_columns_select = ["FORNECEDOR", "REGIAO", "GRUPO"]

# Colunas para normalização de valores
columns_to_remove_accents = true
cells_to_remove_spaces = ["GRUPO"]
cells_to_remove_accents = true

# Validando se é desejado salvar os dados após processamento
validator_save_sot = true
dir_path_file_sot = "data/outputs/sor/01_SOR_BASE_GRUPOS_CONSTRUTORAS.xlsx"

[default.module_validator_lpu.budget_data]

# Caminhos padrão
file_path = "data/outputs/01_BASE_RESULTADO_ORCAMENTOS_CONCATENADOS.xlsx"
sheet_name = "Tables"

# Colunas obrigatórias com tipos
required_columns_with_types = {"ID" = "object", "NOME" = "object", "UNIDADE" = "object", "PRECO PAGO" = "float64", "QUANTIDADE" = "float64", "SOURCE_FILE" = "object", "SHEET_NAME" = "object"}

# Colunas para renomear
columns_to_rename = {"VALOR TOTAL" = "VALOR TOTAL PAGO"}

# Colunas para normalização de valores
cells_to_remove_spaces = []
cells_to_remove_accents = []

column_quantity = "QUANTIDADE"
column_unit_price = "PRECO PAGO"
column_total_value = "VALOR TOTAL"

# Validando se é desejado salvar os dados após processamento
validator_save_sot = true
dir_path_file_sot = "data/outputs/sor/01_SOR_BASE_RESULTADO_ORCAMENTOS_CONCATENADOS.xlsx"

[default.module_validator_lpu.budget_metadados]

# Caminhos padrão
file_path = "data/outputs/01_BASE_RESULTADO_ORCAMENTOS_CONCATENADOS.xlsx"
sheet_name = "Metadata"

# Colunas obrigatórias com tipos
required_columns_with_types = {"CÓDIGO_UPE" = "int", "NUMERO_AGENCIA" = "int", "CONSTRUTORA" = "object", "SOURCE_FILE" = "object"}

# Lista de colunas para selecionar
list_columns_select = ["CÓDIGO_UPE", "NUMERO_AGENCIA", "CONSTRUTORA", "TIPO", "PROGRAMA_DONO", "SOURCE_FILE"]

# Colunas para normalização de valores
cells_to_remove_spaces = []
cells_to_remove_accents = []

column_code_upe = "CÓDIGO_UPE"
column_constructor = "CONSTRUTORA"
column_source_file = "SOURCE_FILE"

# Validando se é desejado salvar os dados após processamento
validator_save_sot = true
dir_path_file_sot = "data/outputs/sor/01_SOR_BASE_RESULTADO_ORCAMENTOS_METADADOS.xlsx"

[default.module_validator_lpu.lpu_data]

file_path = "data/inputs/lpu/BASE_LPU.xlsx"
sheet_name = "LPU"

# Colunas obrigatórias com tipos
required_columns_with_types = {"CÓD ITEM" = "object", "ITEM" = "object", "UNID." = "object"}

# Colunas para normalização de valores
cells_to_remove_spaces = []
cells_to_remove_accents = "true"

# Colunas padrões do padrão long
long_default_columns = {"REGIAO" = "object", "GRUPO" = "object", "PREÇO" = "float64"}

# Colunas para renomear
columns_to_rename = {"PRECO" = "PRECO LPU"}

# Adiciona as variáveis necessárias para regiões e grupos
regions = ["NORTE", "NORDESTE", "CENTRO-OESTE", "SUDESTE", "SUL"]
groups = ["GRUPO1", "GRUPO2", "GRUPO3", "GRUPO 1", "GRUPO 2", "GRUPO 3"]

# Validando se é desejado salvar os dados após processamento
validator_save_sot = true
dir_path_file_sot = "data/outputs/sor/01_SOR_BASE_LPU.xlsx"

[default.module_validator_lpu.merge_budget_metadata]
left_on = "SOURCE_FILE"
right_on = "SOURCE_FILE"
how = "left"
validate = "many_to_one"
indicator = "_merge_bud_met"

# Validando se é desejado salvar os dados após processamento
validator_save_sot = true
dir_path_file_sot = "data/outputs/sot/01_validador_lpu/01_MERGE_ORCA_META.xlsx"

[default.module_validator_lpu.merge_budget_metadata_agencies]
left_on = "NUMERO_AGENCIA"
right_on = "CD_PONTO"
how = "left"
validate = "many_to_one"
indicator = "_merge_bud_met_age"

# Validando se é desejado salvar os dados após processamento
validator_save_sot = true
dir_path_file_sot = "data/outputs/sot/01_validador_lpu/02_MERGE_ORCA_META_AG.xlsx"

[default.module_validator_lpu.merge_budget_metadata_agencies_constructors]

library = "rapidfuzz"
use_multiprocessing = true

left_on = ["CONSTRUTORA", "REGIAO"]
right_on = ["FORNECEDOR", "REGIAO"]
how = "inner"
validate = "many_to_one"
handle_duplicates = true
indicator = "_merge_bud_met_age_constr"

# Threshold usado para o merge fuzzy entre agencias e construtoras
threshold = 70

# Se True, substitui a coluna original pelo best_match e remove colunas auxiliares. Default é False.
replace_column = true

# Validando se é desejado usar merge fuzzy para construtoras
validator_use_merge_fuzzy = true
validator_use_merge_fuzzy_column_left = "CONSTRUTORA"
validator_use_merge_fuzzy_column_right = "FORNECEDOR"

# Validando se é desejado salvar os dados após processamento
validator_save_sot = true
dir_path_file_sot = "data/outputs/sot/01_validador_lpu/03_MERGE_ORCA_META_AG_CONSTRU.xlsx"

[default.module_validator_lpu.merge_budget_lpu]

# Configurações de merge
how = "left"
validate = "many_to_one"

# Colunas do orçamento (df_budget)
columns_on_budget_id = "ID"
columns_on_budget_nome = "NOME"
columns_on_budget_region = "REGIÃO"
columns_on_budget_group = "GRUPO"

# Primeiro conjunto de colunas testadas no merge (na ordem)
columns_budget_merge_one = ["ID", "REGIAO", "GRUPO"]

# Segundo conjunto de colunas testadas no merge (na ordem)
columns_budget_merge_two = ["NOME", "REGIAO", "GRUPO"]

# Colunas da LPU (df_lpu)
columns_on_lpu_id = "CÓD ITEM"
columns_on_lpu_nome = "ITEM"
columns_on_lpu_region = "REGIAO"
columns_on_lpu_group = "GRUPO"

# Primeiro conjunto de colunas testadas no merge (na ordem)
columns_lpu_merge_one = ["CÓD ITEM", "REGIAO", "GRUPO"]

# Segundo conjunto de colunas testadas no merge (na ordem)
columns_lpu_merge_two = ["ITEM", "REGIAO", "GRUPO"]

# Validando se é desejado salvar os dados após processamento
validator_save_sot = true
dir_path_file_sot = "data/outputs/sot/01_validador_lpu/04_MERGE_ORCA_META_AG_CONSTRU_LPU.xlsx"

[default.module_validator_lpu.output_settings]

# Lista de colunas no resultado final
list_columns_result = ['CÓDIGO_UPE', 'PROGRAMA_DONO', 'NUMERO_AGENCIA', 'NOME_AGENCIA', 'REGIAO', 'UF', 'MUNICIPIO', 'CONSTRUTORA', 'GRUPO', 'ID', 'NOME', 'UNIDADE', 'TIPO', 'GRUPO', 'COMENTÁRIO', 'QUANTIDADE', 'PRECO PAGO', 'VALOR TOTAL PAGO', 'PRECO LPU', 'VALOR TOTAL LPU', 'DIFERENÇA TOTAL', 'DISCREPÂNCIA PERCENTUAL', 'RESULTADO VALIDADOR LPU', 'SOURCE_FILE']

# Dict de rename no resultado final
dict_rename_result = {"ID" = "ID ITEM", "NOME" = "NOME ITEM", "UNIDADE" = "UNIDADE ITEM"}

# Nomes dos arquivos de saída
output_dir = "data/outputs"
file_path_output = "spec/02_BASE_RESULTADO_VALIDADOR_LPU.xlsx"
file_path_output_csv = "spec/02_BASE_RESULTADO_VALIDADOR_LPU.csv"
file_path_output_complete_excel = "spec/02_BASE_RESULTADO_COMPLETO_VALIDADOR_LPU.xlsx"

file_path_stats_output_html = "spec/02_ESTATISTICAS_VALIDADOR_LPU.html"
file_path_stats_output_pdf = "spec/02_ESTATISTICAS_VALIDADOR_LPU.pdf"
[default.module_validator_lpu.stats]

# Variável para salvar o relatório de estatísticas em PDF
validator_output_pdf = true

# Variável para salvar o relatório de estatísticas em HTML
validator_output_html = true    

# Configurações de exportação
top_n_divergencias = 10
top_n_divergencias_extended = 20

[default.module_validator_nlpu]

# Tolerância de divergência para status de conciliação (%)
tol_percentile = 0.0

# Colunas padrão para cálculo de discrepâncias
column_quantity = "QUANTIDADE"
column_unit_price_paid = "PRECO PAGO"
column_unit_price_lpu = "PRECO LPU_lpu_0"
column_total_paid = "VALOR TOTAL PAGO"
column_total_lpu = "MATCH FUZZY - VALOR TOTAL"
column_difference = "MATCH FUZZY - DIFERENÇA TOTAL"
column_discrepancy = "MATCH FUZZY - DISCREPÂNCIA PERCENTUAL"
column_status = "RESULTADO VALIDADOR NLPU"
name_status_nullable = ""
name_status_ok = "OK"
name_status_payment_more = "PARA RESSARCIMENTO"
name_status_payment_less = "ABAIXO LPU"

[default.module_validator_nlpu.budget_data]

# Caminhos padrão
output_dir = "data/outputs"
file_path = "spec/02_BASE_RESULTADO_VALIDADOR_LPU.xlsx"
sheet_name = "Sheet1"

# Colunas obrigatórias com tipos
required_columns_with_types = {}

# Colunas para renomear
columns_to_rename = {}

# Colunas para normalização de valores
cells_to_remove_spaces = []
cells_to_remove_accents = []

column_quantity = "QUANTIDADE"
column_unit_price = "PRECO PAGO"
column_total_value = "VALOR TOTAL PAGO"

[default.module_validator_nlpu.match_fuzzy_budget_lpu]

library = "rapidfuzz"
use_multiprocessing = true

# Validador para uso do merge fuzzy
validator_use_merge_fuzzy = true

# Coluna que indica o resultado do merge fuzzy
indicator = "_merge_fuzzy_budget_lpu"

# Nome da coluna que será criado após o match fuzzy
col_best_match = "MATCH FUZZY - ITEM LPU"
col_score_match = "SCORE MATCH FUZZY - ITEM LPU"

# Coluna do Budget para merge fuzzy
column_validator_use_merge_fuzzy_df_left = "NOME ITEM"

# Coluna da LPU para merge fuzzy
column_validator_use_merge_fuzzy_df_right = "ITEM"

# Lista de colunas para merge fuzzy no Budget
list_columns_merge_fuzzy_df_left = ["MATCH FUZZY - ITEM LPU", "REGIAO", "GRUPO"]

# Lista de colunas para merge fuzzy na LPU
list_columns_merge_fuzzy_df_right = ["ITEM", "REGIAO", "GRUPO"]

# Como o merge deve ser feito (preservando dados da base de budget)
how = "left"

# Tipo de validador do merge
validate = "many_to_one"

# Se deve tentar abordagem de merge em dois estágios
use_two_stage_merge = false

# Validando se deve obter as colunas do dataframe da direita quando acontecer o merge
validator_get_columns_from_best_match = false

# Se queremos manter o nome das colunas originais do dataframe da direita (df_lpu)
keep_original_columns_names_df_right = false # Nesse caso, ele irá incluir um suffixo no nome

# Dictionário de colunas para filtro antes do merge fuzzy
filter_cols_to_match = {"RESULTADO VALIDADOR LPU" = ["ITEM NAO LPU"]}

# Validator para substituir a coluna original pelo melhor match
replace_column = false

# Validador para remover colunas auxiliares do resultado
drop_columns_result = false

# Limiar de similaridade para considerar o merge fuzzy
validator_use_merge_fuzzy_threshold = 80

# Validando se é desejado salvar os dados após processamento
validator_save_sot = true
dir_path_file_sot = "data/outputs/sot/02_validador_nlpu/01_MATCH_FUZZY_BUDGET_LPU.xlsx"

[default.module_validator_nlpu.output_settings]

# Lista de colunas no resultado final
list_columns_result = ['CÓDIGO_UPE', 'PROGRAMA_DONO', 'NUMERO_AGENCIA', 'NOME_AGENCIA', 'REGIAO', 'UF', 'MUNICIPIO', 'CONSTRUTORA', 'GRUPO', 'ID', 'NOME ITEM', 'UNIDADE', 'TIPO', 'GRUPO', 'COMENTÁRIO', 'QUANTIDADE', 'PRECO PAGO', 'VALOR TOTAL PAGO', 'PRECO LPU_budget', 'VALOR TOTAL LPU', 'DIFERENÇA TOTAL', 'DISCREPÂNCIA PERCENTUAL', 'RESULTADO VALIDADOR LPU', 'SOURCE_FILE', 'MATCH FUZZY - ITEM LPU', 'SCORE MATCH FUZZY - ITEM LPU', 'CÓD ITEM', 'ITEM', 'PRECO LPU_lpu_0', 'MATCH FUZZY - VALOR TOTAL', 'MATCH FUZZY - DIFERENÇA TOTAL', 'MATCH FUZZY - DISCREPÂNCIA PERCENTUAL', 'RESULTADO VALIDADOR NLPU']

# Dict de rename no resultado final
dict_rename_result = {"PRECO LPU_budget" = "PREÇO LPU", "MATCH FUZZY - ITEM LPU" = "MATCH FUZZY - NOME ITEM LPU", "ITEM" = "MATCH FUZZY - ID ITEM LPU", "PRECO LPU_lpu_0" = "MATCH FUZZY - PREÇO ITEM LPU"}

# Nomes dos arquivos de saída
output_dir = "data/outputs"
file_path_output = "spec/03_BASE_RESULTADO_VALIDADOR_NLPU.xlsx"
file_path_output_csv = "spec/03_BASE_RESULTADO_VALIDADOR_NLPU.csv"
file_path_output_complete_excel = "spec/03_BASE_RESULTADO_COMPLETO_VALIDADOR_NLPU.xlsx"

file_path_stats_output_html = "spec/03_RESULTADO_COMPLETO_VALIDADOR_NLPU.html"
file_path_stats_output_pdf = "spec/03_ESTATISTICAS_VALIDADOR_NLPU.pdf"

[regex_patterns]
group_pattern = "-GRUPO\\d+"

# StackSpot AI Configuration
[default.stackspot]
ai_base_url = "https://api.stackspot.ai/v1"
ai_timeout = 30 # seconds

# Logging Configuration
[default.logging]
level = "INFO"
format = "json"
rotation = "10 MB"
retention = "30 days"

# API Configuration
[default.api]
title = "Verificador Inteligente de Orçamentos de Obras - Serviço de Validação"
host = "0.0.0.0"
port = 8000
reload = false
version = "0.0.1"

# Validators Configuration
[default.validators]
quantity_deviation_threshold = 0.15
unit_price_deviation_threshold = 0.20

# Development Environment
[development]
debug = true

[development.logging]
level = "DEBUG"

[development.api]
reload = true

# Production Environment
[production]
debug = false

[production.logging]
level = "WARNING"

[production.api]
reload = false